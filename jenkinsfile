def javaDockerImage = 'maven:3.8.5-openjdk-17-slim'
def javaDockerImageUrl = "nexus.riaint.ee:8500/library/${javaDockerImage}"


node {
    withCredentials([string(credentialsId: 'webhook_token', variable: 'webhooktoken')]) {
        properties([
            pipelineTriggers([
                [$class          : 'GenericTrigger',
                 genericVariables: [
                     [key: 'webhookActorDisplayName', value: '$.actor.displayName'],
                 ],
                 token           : webhooktoken,
                 causeString     : 'See töö käivitati $webhookActorDisplayName poolt läbi bitbucketi webhooki kaudu',
                 printPostContent: true,
                 silentResponse  : false
                ]
            ])
        ])
    }
}

pipeline {

    parameters {
        string(
            name: 'branch',
            defaultValue: 'master',
            description: '',
            trim: true
        )
    }

    environment {
        INFRAENV = "${env.JOB_NAME}".split('-')[1].split('/')[0].toLowerCase()
        TLD = "${env.INFRAENV}.riaint.ee"
        DOCKER_IMAGE_REPOSITORY = 'harbor.riaint.ee/cdoc2'
        DOCKER_CREDENTIALS_ID = 'cdoc2-jenkins-harbor'
        PUT_SERVER_DOCKER_IMG_NAME = 'cdoc20-put-server'
        GET_SERVER_DOCKER_IMG_NAME = 'cdoc20-get-server'
        DB_LIQUIBASE_DOCKER_IMG_NAME = 'cdoc20-server-liquibase'
    }

    agent any

    stages {
        stage('Clone sources') {
            steps {
                git branch: "${branch}", credentialsId: 'bitbucket-ssh', url: 'ssh://git@stash.ria.ee:7799/cdoc2/cdoc20_java.git'
            }
        }

        stage('Compile and test') {
            steps {
                // Running-as-non-root inside Docker currently not done, because using Docker inside Docker requires
                // root inside Docker or setting up more detailed permissions for /var/run/docker.sock
                sh('docker run --rm ' +
                   ' --volume /var/run/docker.sock:/var/run/docker.sock ' +
                   ' --volume "$PWD:/usr/src/project"' +
                   ' --volume /dev/urandom:/dev/random' +
                   ' --workdir /usr/src/project' +
                   " ${javaDockerImageUrl} " +
                   ' mvn --batch-mode -s ria-settings.xml -Duser.home=/usr/src/project -DskipTests=false clean install'
                )
            }
        }

        stage('Build and Push Key Server Docker Images') {
            steps {
                // Running-as-non-root inside Docker currently not done, because using Docker inside Docker requires
                // root inside Docker or setting up more detailed permissions for /var/run/docker.sock
                sh('docker run --rm ' +
                   ' --volume /var/run/docker.sock:/var/run/docker.sock ' +
                   ' --volume "$PWD:/usr/src/project"' +
                   ' --workdir /usr/src/project' +
                   " ${javaDockerImageUrl} " +
                   ' mvn --batch-mode -s ria-settings.xml -Duser.home=/usr/src/project -DskipTests=true ' +
                   ' -Dspring-boot.build-image.runImage=nexus.riaint.ee:8500/paketobuildpacks/builder:0.1.185-base' +
                   ' -Dspring-boot.build-image.runImage=nexus.riaint.ee:8500/paketobuildpacks/run:1.1.32-base-cnb' +
                   " -Dspring-boot.build-image.imageName=${env.PUT_SERVER_DOCKER_IMG_NAME}" +
                   ' -Dmaven.test.skip=true' +
                   ' -pl cdoc20-server/put-server/ spring-boot:build-image'
                )
                sh("docker tag ${env.PUT_SERVER_DOCKER_IMG_NAME} ${env.DOCKER_IMAGE_REPOSITORY}/${env.PUT_SERVER_DOCKER_IMG_NAME}:latest")
                script {
                    dockerImage = docker.image("${env.DOCKER_IMAGE_REPOSITORY}/${env.PUT_SERVER_DOCKER_IMG_NAME}:latest")
                    docker.withRegistry('https://harbor.riaint.ee/', env.DOCKER_CREDENTIALS_ID) {
                        dockerImage.push()
                    }
                }
                sh('docker run --rm ' +
                   ' --volume /var/run/docker.sock:/var/run/docker.sock ' +
                   ' --volume "$PWD:/usr/src/project"' +
                   ' --workdir /usr/src/project' +
                   " ${javaDockerImageUrl} " +
                   ' mvn --batch-mode -s ria-settings.xml -Duser.home=/usr/src/project -DskipTests=true ' +
                   ' -Dspring-boot.build-image.runImage=nexus.riaint.ee:8500/paketobuildpacks/builder:0.1.185-base' +
                   ' -Dspring-boot.build-image.runImage=nexus.riaint.ee:8500/paketobuildpacks/run:1.1.32-base-cnb' +
                   " -Dspring-boot.build-image.imageName=${env.GET_SERVER_DOCKER_IMG_NAME}" +
                   ' -Dmaven.test.skip=true' +
                   ' -pl cdoc20-server/get-server/ spring-boot:build-image'
                )
                sh("docker tag ${env.GET_SERVER_DOCKER_IMG_NAME} ${env.DOCKER_IMAGE_REPOSITORY}/${env.GET_SERVER_DOCKER_IMG_NAME}:latest")
                script {
                    dockerImage = docker.image("${env.DOCKER_IMAGE_REPOSITORY}/${env.GET_SERVER_DOCKER_IMG_NAME}:latest")
                    docker.withRegistry('https://harbor.riaint.ee/', env.DOCKER_CREDENTIALS_ID) {
                        dockerImage.push()
                    }
                }
            }
        }

        stage('Build and Push Key Server Liquibase Docker Image') {
            steps {
                dir('cdoc20-server/server-db/src/main/resources/db') {
                    sh("docker build -t ${env.DB_LIQUIBASE_DOCKER_IMG_NAME} .")
                    sh("docker tag ${env.DB_LIQUIBASE_DOCKER_IMG_NAME}:latest ${env.DOCKER_IMAGE_REPOSITORY}/${env.DB_LIQUIBASE_DOCKER_IMG_NAME}:latest")
                    script {
                        dockerImage = docker.image("${env.DOCKER_IMAGE_REPOSITORY}/${env.DB_LIQUIBASE_DOCKER_IMG_NAME}:latest")
                        docker.withRegistry('https://harbor.riaint.ee/', env.DOCKER_CREDENTIALS_ID) {
                            dockerImage.push()
                        }
                    }
                }
            }
        }

        stage('Update Key Server instance') {
            steps {
                script {
                    callWithSshCredentials("cdoc2-keyserver-01", { remote ->
                        sshCommand(remote: remote, command: "sh /home/riajenk/update-server.sh")
                    })
                }
            }
        }

        stage('Deploy java artifacts to Nexus') {
            agent {
                docker {
                    image "${javaDockerImageUrl}"
                    args  "--volume $HOME/.m2:/var/maven/.m2 "+
                    "--volume $PWD:/usr/src/project "+
                    "--workdir /usr/src/project " +
                    "--env MAVEN_CONFIG=/var/maven/.m2 "
                }
            }
            steps {
                withCredentials([usernamePassword(credentialsId: 'nexus-cdoc2-maven-local', usernameVariable: 'NEXUS_user', passwordVariable: 'NEXUS_pass')]) {
                    /*sh('mvn --batch-mode -s ria-settings.xml -Duser.home=/usr/src/project '+
                       '-DskipTests deploy -DaltDeploymentRepository=credentials::default::https://nexus.riaint.ee/repository/cdoc2-maven-local/ ' +
                       "-Dusername=${NEXUS_user} -Dpassword=${NEXUS_pass} -Dcheckstyle.output.file=/tmp/cdoc2-checkstyle.xml"
                    )*/
                    sh 'ls -alth cdoc20-lib/target'
                }
            }
        }
    }
}

def callWithSshCredentials(String node, Closure action) {
    withCredentials([sshUserPrivateKey(credentialsId: 'riajenk-ssh', usernameVariable: 'username', keyFileVariable: 'keyfile')]) {
        def remote = [:]
        remote.name = node
        remote.host = "${node}.${env.TLD}"
        remote.user = username
        remote.identityFile = keyfile
        remote.allowAnyHosts = true
        action.call(remote)
    }
}

